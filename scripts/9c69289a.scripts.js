"use strict";angular.module("lelylan.dashboards.device",["lelylan.dashboards.device.dimension","lelylan.dashboards.device.column","lelylan.dashboards.device.menu","lelylan.dashboards.device.socket","lelylan.dashboards.device.notifications","lelylan.directives.device","config","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/devices.html",controller:"DevicesCtrl"}).when("/create",{templateUrl:"views/create.html",controller:"CreateCtrl"}).when("/notifications",{templateUrl:"views/notifications.html",controller:"NotificationsCtrl"}).when("/login",{templateUrl:"views/login.html",controller:["$rootScope","$timeout","AccessToken",function(a,b,c){a.loading=!1,b(function(){console.log("Access Token",!!c.get()),c.get()&&($location.path("/"),$location.replace())},0)}]}).when("/expired",{templateUrl:"views/expired.html",controller:["$rootScope",function(a){a.loading=!1}]}).when("/no-devices",{templateUrl:"views/no-devices.html",controller:["$rootScope",function(a){a.loading=!1}]}).when("/access_token=:accessToken",{template:"-",controller:["$location","$route","$routeParams","$timeout","AccessToken",function(a,b,c,d,e){var f=a.path().substr(1);e.setTokenFromString(f),a.path("/"),a.replace()}]}).otherwise({redirectTo:"/"})}]),angular.module("config",[]).constant("ENV",{name:"production",endpoint:"http://api.lelylan.com",credentials:{site:"http://people.lelylan.com",clientId:"3bfdab6de9b9f2b82c595bd8befef178d5ea929dc40b0848de6a67b2a182d709",redirectUri:"http://lelylan.github.io/devices-dashboard-ng",profileUri:"http://api.lelylan.com/me"},websocket:"ws://96.126.109.170:80"}),angular.module("lelylan.dashboards.device").controller("MainCtrl",["$scope","$rootScope","$timeout","$q","$location","$route","$cacheFactory","ENV","Device","Type","Category","AccessToken","Dimension","Column","Menu","Notifications","Socket",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){a.demo=!!e.absUrl().match(/demo/),c(function(){a.logged=!!l.get()},0),a.dimensions=m.get(),a.columns=n.get(),a.menu=o.get(),a.credentials=h.credentials,b.notifications={list:p.get(),unread:0},b.notification={},b.types=[],c(function(){var c=!!l.get();a.demo||(c||e.path("login"),a.$on("oauth:logout",function(){e.path("login"),o.set("lelylan")})),b.load()},0),b.load=function(){var c=(g.get("$http").get(h.endpoint+"/categories"),k.all().success(function(a){b.categories=a,b.categories.unshift({tag:"all",name:"All"}),b.currentCategory=b.categories[0]})),f=i.all().success(function(a){b.all=a,b.devices=a,0==a.length?e.path("/no-devices"):l(b.devices)});d.all([f,c]).then(function(){_.map(b.categories,function(a){a.devices=_.countBy(b.all,function(b){return b.category==a.tag?"count":"missed"}).count}),b.categories[0].devices=b.all.length});var l=function(a){var c=[],e=_.map(a,function(a){var b=_.contains(c,a.type.id);return b?void 0:(c.push(a.type.id),j.find(a.type.id))}),e=_.reject(e,function(a){return void 0==a});d.all(e).then(function(a){b.types=_.map(a,function(a){return a.data}),m(a)})},m=function(){b.loading=!1,a.currentDevice=b.devices[0]}},a.$on("oauth:expired",function(){e.path("expired")}),b.demoOn=function(){b.loading=!0,c(function(){window.location.replace("demo.html")},300)},b.demoOff=function(){c(function(){window.location.replace("index.html"),b.loading=!0},300)},c(function(){var d=!!l.get();d&&(q.on("connect",function(){q.emit("subscribe",l.get().access_token)}),q.on("update",function(d){var e=p.push(d.data);b.$broadcast("lelylan:device:update:set",d.data),"NotificationsCtrl"!=f.current.$$route.controller&&(e.length>0&&e[0].changes.length>0?(b.notification.show||(a.dimensions.height-=2),b.notification.timeout&&c.cancel(b.notification.timeout),b.notification.timeoutHeight&&c.cancel(b.notification.timeoutHeight),b.notification.show=!0,b.notification.message=e[0].message,b.notification.device=e[0].device,b.notification.timeout=c(function(){b.notification.show=!1},5e3),b.notification.timeoutHeight=c(function(){a.dimensions.height+=2},5500)):b.notifications.list.shift()),r()}))}),a.$on("lelylan:device:update:set",function(a,c){var d=_.find(b.all,function(a){return a.id==c.id});angular.extend(d,c)}),a.$on("$routeChangeStart",function(){1==b.archiveNotifications&&(b.archiveNotifications=!1,_.each(b.notifications.list,function(a){a.unread=!1})),r()});var r=function(){b.notifications.unread=_.where(b.notifications.list,{unread:!0}).length,b.notifications.unread>=50&&(b.notifications.unread="+50")}}]),angular.module("lelylan.dashboards.device").controller("DevicesCtrl",["$scope","$rootScope","$timeout","$q","$location","$route","$cacheFactory","ENV","Device","Type","Category","AccessToken","Dimension","Column","Menu",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){a.demo||b.load(),a.setCategory=function(c){c.devices&&(b.devices="all"==c.tag?b.all:_.where(b.all,{category:c.tag}),a.currentDevice=b.devices[0],b.currentCategory=c,"one"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!1}),n.set(a.dimensions)))},b.$on("lelylan:device:custom:open",function(b,c){a.currentDevice=c,"two"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!0}),o.set("categories")),"one"==a.columns.count&&(n.setVisible({one:!1,two:!1,three:!0}),o.set("devices"))}),b.$on("lelylan:device:delete",function(b,c){var d=g.get("$http").get(h.endpoint+"/devices"),e=JSON.parse(d[1]),i=_.find(e,function(a){return a.id==c.id});if(i){var j=e.indexOf(i);e.splice(j,1),d[1]=JSON.stringify(e)}"one"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!1}),o.set("categories")),f.reload()}),b.moveToCategories=function(){"two"==a.columns.count&&(n.setVisible({one:!0,two:!0,three:!1}),o.set("none")),"one"==a.columns.count&&(n.setVisible({one:!0,two:!1,three:!1}),o.set("none"))},b.moveToDevices=function(){"one"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!1}),o.set("categories"))},"one"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!1}),o.set("categories"))}]),angular.module("lelylan.dashboards.device").controller("CreateCtrl",["$scope","$rootScope","$location","$cacheFactory","ENV","Device","Type","AccessToken","Menu",function(a,b,c,d,e,f,g,h,i){b.loading=!1,a.step="one",a.device={},a.invalid={};g.popular().success(function(b){a.popular=b});i.set("lelylan"),a.setStep=function(b){a.step=b},a.setName=function(){a.invalid.one=!1,a.setStep("two")},a.setType=function(b){a.device.type={id:b.id},a.invalid.two=!1,a.setStep("three")},a.setPhysical=function(c){a.device.name||(a.invalid.one=!0),a.device.type||(a.invalid.two=!0),a.device.name&&a.device.type&&(b.loading=!0,"simulation"==c&&f.create(a.device).success(j),"mqtt"==c&&f.create(a.device).success(function(b){a.device.physical={uri:"http://nodes.lelylan.com/mqtt/devices/"+b.id},f.update(b.id,a.device).success(j)}),"custom"==c&&f.create(a.device).success(j))};var j=function(a){var f=d.get("$http").get(e.endpoint+"/devices");if(f){var g=JSON.parse(f[1]);g.unshift(a),f[1]=JSON.stringify(g);var h=_.find(b.categories,function(b){return b.tag==a.category});h.devices++,b.currentCategory=b.categories[0],b.currentDevice=b.all[0]}c.path("/"),b.loading=!1}}]),angular.module("lelylan.dashboards.device").controller("NotificationsCtrl",["$scope","$rootScope","$location","Menu",function(a,b,c,d){b.loading=!1,b.notification.show=!1,b.archiveNotifications=!0,d.set("lelylan")}]);var service=angular.module("lelylan.dashboards.device.dimension",[]);service.factory("Dimension",["$window","$rootScope","Column",function(a,b,c){var d=angular.element(a),e={},f={menu:4.3,spacing:.5},g={};g.get=function(){return e};var h=function(){e.width=i(d.width()),e.height=i(d.height())-f.menu,c.set(e),"one"==c.get().count&&(e.height+=f.spacing)},i=function(a){var b=parseFloat($("body").css("font-size"));return a/b};return d.bind("resize",function(){b.$apply(function(){h()})}),h(),g}]);var service=angular.module("lelylan.dashboards.device.column",[]);service.factory("Column",["$location","Menu",function(a,b){var c={},d={three:69,two:46},e={visible:{one:!1,two:!1,three:!1},count:void 0};c.get=function(){return e},c.set=function(c){f(c),g(c),h(c),"/"!=a.path()&&b.set("lelylan")};var f=function(a){a.width>d.three&&("three"!=e.count&&(e.visible={one:!0,two:!0,three:!0}),b.set("lelylan"),e.count="three")},g=function(a){a.width<d.three&&a.width>d.two&&("two"!=e.count&&(e.visible={one:!1,two:!0,three:!0}),e.visible.one&&b.set("none"),e.visible.two&&b.set("categories"),e.count="two")},h=function(a){a.width<d.two&&("one"!=e.count&&(e.visible={one:!1,two:!0,three:!1}),e.visible.one&&b.set("none"),e.visible.two&&b.set("categories"),e.visible.three&&b.set("devices"),e.count="one")};return c.setVisible=function(a){e.visible=a},c}]);var service=angular.module("lelylan.dashboards.device.menu",[]);service.factory("Menu",function(){var a={},b={visible:{lelylan:!1,categories:!1,devices:!1}};return a.get=function(){return b},a.set=function(a){_.each(b.visible,function(c,d){b.visible[d]=d==a?!0:!1})},a});var service=angular.module("lelylan.dashboards.device.socket",[]);service.factory("Socket",["$rootScope","ENV",function(a,b){var c=io.connect(b.websocket);return{on:function(b,d){c.on(b,function(){var b=arguments;a.$apply(function(){d.apply(c,b)})})},emit:function(b,d,e){c.emit(b,d,function(){var b=arguments;a.$apply(function(){e&&e.apply(c,b)})})}}}]);var service=angular.module("lelylan.dashboards.device.notifications",[]);service.factory("Notifications",["$rootScope","Type",function(a){var b={},c=[];b.get=function(){return c},b.push=function(a){var b=f(a.id),g=d(b,a),h=e(a,g);return c.unshift({unread:!0,device:a,previous:b,changes:g,message:h}),c.length>51&&c.pop(),c};var d=function(a,b){var c=[];return _.each(a.properties,function(d,e){if(a.properties[e].value!=b.properties[e].value){var f={},h=g(b.type.id);f.name=_.find(h.properties,function(a){return a.id==d.id}).name,f.previous=a.properties[e].value,f.value=b.properties[e].value,c.push(f)}}),c},e=function(a,b){var c="Changed its ";return _.each(b,function(a,d){c=c+a.name+" to "+a.value,d+1!=b.length&&(c+=", ")}),c},f=function(b){return _.find(a.all,function(a){return a.id==b})},g=function(b){return _.find(a.types,function(a){return a.id==b})};return b}]);