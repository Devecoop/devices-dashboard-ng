"use strict";angular.module("lelylan.dashboards.device",["lelylan.dashboards.device.dimension","lelylan.dashboards.device.column","lelylan.dashboards.device.menu","lelylan.directives.device","config","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/devices.html",controller:"DevicesCtrl"}).when("/create",{templateUrl:"views/create.html",controller:"CreateCtrl"}).when("/login",{templateUrl:"views/login.html",controller:["$rootScope",function(a){a.loading=!1}]}).when("/expired",{templateUrl:"views/expired.html",controller:["$rootScope",function(a){a.loading=!1}]}).when("/empty",{templateUrl:"views/empty.html",controller:["$rootScope",function(a){a.loading=!1}]}).when("/access_token=:accessToken",{template:"-",controller:["$location","$route","$routeParams","$timeout","AccessToken",function(a,b,c,d,e){var f=a.path().substr(1);e.setTokenFromString(f),a.path("/"),a.replace()}]}).otherwise({redirectTo:"/"})}]),angular.module("config",[]).constant("ENV",{name:"production",endpoint:"http://api.lelylan.com",credentials:{site:"http://people.lelylan.com",clientId:"3bfdab6de9b9f2b82c595bd8befef178d5ea929dc40b0848de6a67b2a182d709",redirectUri:"http://lelylan.github.io/devices-dashboard-ng",profileUri:"http://api.lelylan.com/me"}}),angular.module("lelylan.dashboards.device").controller("MainCtrl",["$scope","$rootScope","$timeout","$q","$location","$cacheFactory","ENV","Device","Type","Category","AccessToken","Dimension","Column","Menu",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){a.demo=!!e.absUrl().match(/demo/),a.dimensions=l.get(),a.columns=m.get(),a.menu=n.get(),a.credentials=g.credentials,c(function(){var b=!!k.get();a.demo||(b||e.path("login"),a.$on("oauth:logout",function(){e.path("login")}))},0),a.$on("oauth:expired",function(){e.path("expired")}),b.demoOn=function(){b.loading=!0,c(function(){window.location.replace("/demo.html")},300)},b.demoOff=function(){c(function(){window.location.replace("/"),b.loading=!0},300)}}]),angular.module("lelylan.dashboards.device").controller("DevicesCtrl",["$scope","$rootScope","$timeout","$q","$location","$route","$cacheFactory","ENV","Device","Type","Category","AccessToken","Dimension","Column","Menu",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p=(g.get("$http").get(h.endpoint+"/categories"),k.all().success(function(a){b.categories=a,b.categories.unshift({tag:"all",name:"All"})})),q=i.all().success(function(a){b.all=a,b.devices=a,0==a.length?e.path("/empty"):r(b.devices)});d.all([q,p]).then(function(){_.map(b.categories,function(a){a.devices=_.countBy(b.all,function(b){return b.category==a.tag?"count":"missed"}).count}),b.categories[0].devices=b.all.length});var r=function(a){var b=_.map(a,function(a){return j.find(a.type.id)});d.all(b).then(function(a){s(a)})},s=function(){b.loading=!1,a.currentDevice=b.devices[0],b.currentCategory=b.categories[0]};a.setCategory=function(c){c.devices&&(b.devices="all"==c.tag?b.all:_.where(b.all,{category:c.tag}),a.currentDevice=b.devices[0],b.currentCategory=c,"one"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!1}),n.set(a.dimensions)))},b.$on("lelylan:device:custom:open",function(b,c){a.currentDevice=c,"two"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!0}),o.set("categories")),"one"==a.columns.count&&(n.setVisible({one:!1,two:!1,three:!0}),o.set("devices"))}),a.$on("lelylan:device:update:set",function(a,c){var d=_.find(b.devices,function(a){return a.id==c.id});angular.extend(d,c)}),b.$on("lelylan:device:delete",function(b,c){var d=g.get("$http").get(h.endpoint+"/devices"),e=JSON.parse(d[1]),i=_.find(e,function(a){return a.id==c.id});if(i){var j=e.indexOf(i);e.splice(j,1),d[1]=JSON.stringify(e)}"one"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!1}),o.set("categories")),f.reload()}),b.moveToCategories=function(){"two"==a.columns.count&&(n.setVisible({one:!0,two:!0,three:!1}),o.set("none")),"one"==a.columns.count&&(n.setVisible({one:!0,two:!1,three:!1}),o.set("none"))},b.moveToDevices=function(){"one"==a.columns.count&&(n.setVisible({one:!1,two:!0,three:!1}),o.set("categories"))}}]),angular.module("lelylan.dashboards.device").controller("CreateCtrl",["$scope","$rootScope","$location","$cacheFactory","ENV","Device","Type","AccessToken",function(a,b,c,d,e,f,g){b.loading=!1,a.step="one",a.device={},a.invalid={};g.popular().success(function(b){a.popular=b});a.setStep=function(b){a.step=b},a.setName=function(){a.invalid.one=!1,a.setStep("two")},a.setType=function(b){a.device.type={id:b.id},a.invalid.two=!1,a.setStep("three")},a.setPhysical=function(c){a.device.name||(a.invalid.one=!0),a.device.type||(a.invalid.two=!0),a.device.name&&a.device.type&&(b.loading=!0,"simulation"==c&&f.create(a.device).success(h),"mqtt"==c&&f.create(a.device).success(function(b){a.device.physical={uri:"http://nodes.lelylan.com/mqtt/devices/"+b.id},f.update(b.id,a.device).success(h)}),"custom"==c&&f.create(a.device).success(h))};var h=function(a){var f=d.get("$http").get(e.endpoint+"/devices");if(f){var g=JSON.parse(f[1]);g.unshift(a),f[1]=JSON.stringify(g);var h=_.find(b.categories,function(b){return b.tag==a.category});h.devices++,b.currentCategory=b.categories[0],b.currentDevice=b.all[0]}c.path("/")}}]);var service=angular.module("lelylan.dashboards.device.dimension",[]);service.factory("Dimension",["$window","$rootScope","Column",function(a,b,c){var d=angular.element(a),e={},f={menu:4.3,spacing:.5},g={};g.get=function(){return e};var h=function(){e.width=i(d.width()),e.height=i(d.height())-f.menu,c.set(e),"one"==c.get().count&&(e.height+=f.spacing)},i=function(a){var b=parseFloat($("body").css("font-size"));return a/b};return d.bind("resize",function(){b.$apply(function(){h()})}),h(),g}]);var service=angular.module("lelylan.dashboards.device.column",[]);service.factory("Column",["$location","Menu",function(a,b){var c={},d={three:69,two:46},e={visible:{one:!1,two:!1,three:!1},count:void 0};c.get=function(){return e},c.set=function(c){f(c),g(c),h(c),"/"!=a.path()&&b.set("lelylan")};var f=function(a){a.width>d.three&&("three"!=e.count&&(e.visible={one:!0,two:!0,three:!0}),b.set("lelylan"),e.count="three")},g=function(a){a.width<d.three&&a.width>d.two&&("two"!=e.count&&(e.visible={one:!1,two:!0,three:!0}),e.visible.one&&b.set("none"),e.visible.two&&b.set("categories"),e.count="two")},h=function(a){a.width<d.two&&("one"!=e.count&&(e.visible={one:!1,two:!0,three:!1}),e.visible.one&&b.set("none"),e.visible.two&&b.set("categories"),e.visible.three&&b.set("devices"),e.count="one")};return c.setVisible=function(a){e.visible=a},c}]);var service=angular.module("lelylan.dashboards.device.menu",[]);service.factory("Menu",function(){var a={},b={visible:{lelylan:!1,categories:!1,devices:!1}};return a.get=function(){return b},a.set=function(a){_.each(b.visible,function(c,d){b.visible[d]=d==a?!0:!1})},a});